import time
import os
import sys
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.firefox.service import Service

# Cáº¥u hÃ¬nh UTF-8 cho Ä‘áº§u ra terminal
sys.stdout.reconfigure(encoding='utf-8')
# Äá»‹nh nghÄ©a cÃ¡c tráº¡ng thÃ¡i há»™i thoáº¡i
WAITING_INFO, WAITING_OTP = range(2)

# LÆ°u trá»¯ thÃ´ng tin ngÆ°á»i dÃ¹ng táº¡m thá»i
user_data = {}

# Biáº¿n cá» báº­t/táº¯t cháº¿ Ä‘á»™ cháº¡y ná»n
headless_mode = True  # Äáº·t True Ä‘á»ƒ cháº¡y ná»n, False Ä‘á»ƒ xem trÃ¬nh duyá»‡t

def kill_firefox_processes():
    """Kill táº¥t cáº£ cÃ¡c process Firefox vÃ  geckodriver trÃªn Windows"""
    try:
        os.system("taskkill /f /im firefox.exe >nul 2>&1")
        os.system("taskkill /f /im geckodriver.exe >nul 2>&1")
        time.sleep(3)  # Äá»£i process Ä‘Æ°á»£c kill hoÃ n toÃ n
    except Exception as e:
        print(f"Lá»—i khi kill Firefox: {str(e)}")

# ThÃªm biáº¿n toÃ n cá»¥c Ä‘á»ƒ theo dÃµi phiÃªn ngÆ°á»i dÃ¹ng
active_sessions = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Báº¯t Ä‘áº§u má»™t phiÃªn má»›i."""
    user_id = update.effective_user.id

    # Kiá»ƒm tra náº¿u ngÆ°á»i dÃ¹ng Ä‘Ã£ cÃ³ phiÃªn hoáº¡t Ä‘á»™ng
    if active_sessions.get(user_id):
        await update.message.reply_text(
            "âš ï¸ Báº¡n Ä‘ang cÃ³ má»™t phiÃªn hoáº¡t Ä‘á»™ng. Nháº­p /cancel Ä‘á»ƒ há»§y trÆ°á»›c khi báº¯t Ä‘áº§u má»›i."
        )
        return ConversationHandler.END

    # ÄÃ¡nh dáº¥u phiÃªn ngÆ°á»i dÃ¹ng Ä‘ang hoáº¡t Ä‘á»™ng
    active_sessions[user_id] = True

    await update.message.reply_text(
        "ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i bot Ä‘á»•i máº­t kháº©u VTC!\n"
        "HÃ£y nháº­p thÃ´ng tin theo Ä‘á»‹nh dáº¡ng sau:\n"
        "`tÃ i khoáº£n|máº­t kháº©u cÅ©|máº­t kháº©u má»›i|sá»‘ Ä‘iá»‡n thoáº¡i|Y/N`\n"
        "(Y: há»§y xÃ¡c thá»±c sá»‘ Ä‘iá»‡n thoáº¡i, N: khÃ´ng há»§y xÃ¡c thá»±c)",
        parse_mode='Markdown'
    )
    return WAITING_INFO

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Há»§y thao tÃ¡c hiá»‡n táº¡i vÃ  dá»n dáº¹p tÃ i nguyÃªn."""
    user_id = update.effective_user.id

    # Kiá»ƒm tra náº¿u ngÆ°á»i dÃ¹ng cÃ³ phiÃªn hoáº¡t Ä‘á»™ng
    if not active_sessions.get(user_id):
        await update.message.reply_text("âŒ KhÃ´ng cÃ³ phiÃªn hoáº¡t Ä‘á»™ng Ä‘á»ƒ há»§y.")
        return ConversationHandler.END

    # Dá»n dáº¹p tÃ i nguyÃªn vÃ  Ä‘Ã¡nh dáº¥u phiÃªn khÃ´ng hoáº¡t Ä‘á»™ng
    cleanup_driver(user_id)
    await update.message.reply_text("âŒ ÄÃ£ há»§y thao tÃ¡c vÃ  dá»n dáº¹p tÃ i nguyÃªn.")
    return ConversationHandler.END

async def update_status(update: Update, message: str):
    """Gá»­i thÃ´ng bÃ¡o tráº¡ng thÃ¡i tá»›i ngÆ°á»i dÃ¹ng."""
    await update.message.reply_text(message)


def cleanup_driver(user_id):
    """Dá»n dáº¹p trÃ¬nh duyá»‡t vÃ  xÃ³a dá»¯ liá»‡u ngÆ°á»i dÃ¹ng"""
    session = user_data.pop(user_id, None)
    if session and session.get('driver'):
        try:
            session['driver'].quit()
        except Exception as e:
            print(f"Lá»—i khi Ä‘Ã³ng driver: {str(e)}")
        finally:
            kill_firefox_processes()

    active_sessions.pop(user_id, None)

async def process_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    info = update.message.text

    try:
        # Kill Firefox hiá»‡n táº¡i
        kill_firefox_processes()

        # Split input including the Y/N option
        parts = info.split('|')
        if len(parts) != 5:
            await update.message.reply_text("âŒ Vui lÃ²ng nháº­p Ä‘Ãºng Ä‘á»‹nh dáº¡ng: tÃ i khoáº£n|máº­t kháº©u cÅ©|máº­t kháº©u má»›i|sá»‘ Ä‘iá»‡n thoáº¡i|Y/N")
            return ConversationHandler.END

        username, password, newpass, phone, unverify_option = parts

        # Validate Y/N option
        if unverify_option.upper() not in ['Y', 'N']:
            await update.message.reply_text("âŒ TÃ¹y chá»n há»§y xÃ¡c thá»±c pháº£i lÃ  Y hoáº·c N")
            return ConversationHandler.END

        user_data[user_id] = {
            'username': username,
            'password': password,
            'newpass': newpass,
            'phone': phone,
            'unverify': unverify_option.upper() == 'Y',
            'driver': None
        }

        # CÃ i Ä‘áº·t Firefox cháº¡y áº©n hoáº·c khÃ´ng
        firefox_options = Options()
        if headless_mode:
            firefox_options.add_argument('--headless')

        firefox_options.add_argument('--disable-gpu')
        firefox_options.add_argument('--no-sandbox')
        firefox_options.add_argument('--disable-dev-shm-usage')
        firefox_options.page_load_strategy = 'normal'

        service = Service(log_output=None)
        driver = webdriver.Firefox(options=firefox_options, service=service)
        driver.maximize_window()
        driver.set_page_load_timeout(45)
        user_data[user_id]['driver'] = driver

        # QuÃ¡ trÃ¬nh Ä‘Äƒng nháº­p
        await update_status(update, "â³ Äang má»Ÿ trang Ä‘Äƒng nháº­p...")
        driver.get("https://vtcgame.vn/bao-mat/smsplus")
        time.sleep(1)

        wait = WebDriverWait(driver, 60)

        await update_status(update, "âŒ¨ï¸ Äang nháº­p thÃ´ng tin Ä‘Äƒng nháº­p...")
        username_field = wait.until(EC.presence_of_element_located((By.ID, "phone_number")))
        time.sleep(1)
        username_field.clear()
        time.sleep(1)
        username_field.send_keys(username)
        time.sleep(1)

        password_field = driver.find_element(By.ID, "txtPass")
        password_field.clear()
        time.sleep(1)
        password_field.send_keys(password)
        time.sleep(2)

        await update_status(update, "ğŸ”„ Äang xá»­ lÃ½ Ä‘Äƒng nháº­p...")
        login_button = driver.find_element(By.XPATH, "//a[@onclick='checkValidRegByMobile();']")
        login_button.click()
        time.sleep(3)

        await update_status(update, "ğŸ“± Äang thiáº¿t láº­p SMS Plus...")
        show_popup_button = wait.until(EC.presence_of_element_located((By.XPATH, "//a[@onclick='Account.ShowPopupSMSPlus(false);']")))
        time.sleep(2)
        show_popup_button.click()
        time.sleep(2)

        phone_input = wait.until(EC.presence_of_element_located((By.ID, "txtPhone")))
        phone_input.clear()
        time.sleep(1)
        phone_input.send_keys(phone)
        time.sleep(2)

        step1_button = wait.until(EC.element_to_be_clickable((By.ID, "step1")))
        step1_button.click()
        time.sleep(2)

        await update_status(update, "ğŸ“¤ Vui lÃ²ng Ä‘á»£i tin nháº¯n OTP vÃ  nháº­p mÃ£ OTP:")
        return WAITING_OTP

    except Exception as e:
        await update_status(update, f"âŒ CÃ³ lá»—i xáº£y ra: {e}")
        cleanup_driver(user_id)
        return ConversationHandler.END

async def process_otp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    otp = update.message.text
    driver = user_data[user_id]['driver']

    try:
        wait = WebDriverWait(driver, 30)

        # XÃ¡c thá»±c SMS Plus
        await update_status(update, "ğŸ” Äang xÃ¡c thá»±c SMS Plus...")
        otp_input = wait.until(EC.presence_of_element_located((By.ID, "txtOTPPhone")))
        time.sleep(3)
        otp_input.clear()
        time.sleep(1)
        otp_input.send_keys(otp)
        time.sleep(1)

        confirm_button = driver.find_element(By.CLASS_NAME, "popup-body__btn")
        confirm_button.click()
        time.sleep(1)

        # Äá»•i máº­t kháº©u
        await update_status(update, "ğŸ”„ Äang chuyá»ƒn sang trang Ä‘á»•i máº­t kháº©u...")
        driver.get("https://vtcgame.vn/bao-mat/doi-mat-khau")
        time.sleep(1)

        await update_status(update, "ğŸ”„ Äang Ä‘á»•i máº­t kháº©u...")
        old_password_input = wait.until(EC.presence_of_element_located((By.ID, "txtPassOld")))
        time.sleep(1)
        old_password_input.clear()
        time.sleep(1)
        old_password_input.send_keys(user_data[user_id]['password'])
        time.sleep(2)

        btn_primary = wait.until(EC.element_to_be_clickable((By.CLASS_NAME, "btn.btn-primary")))
        time.sleep(1)
        btn_primary.click()
        time.sleep(1)

        otp_input = wait.until(EC.presence_of_element_located((By.ID, "txtOtp")))
        time.sleep(1)
        otp_input.clear()
        time.sleep(1)
        otp_input.send_keys(otp)
        time.sleep(2)

        confirm_button = wait.until(EC.element_to_be_clickable((By.CLASS_NAME, 'popup-body__btn')))
        time.sleep(1)
        confirm_button.click()
        time.sleep(1)

        new_password_input = wait.until(EC.presence_of_element_located((By.ID, "txtNewPass")))
        time.sleep(1)
        new_password_input.clear()
        time.sleep(1)
        new_password_input.send_keys(user_data[user_id]['newpass'])
        time.sleep(1)

        re_new_password_input = driver.find_element(By.ID, "txtReNewPass")
        re_new_password_input.clear()
        time.sleep(1)
        re_new_password_input.send_keys(user_data[user_id]['newpass'])
        time.sleep(1)

        btn_capnhat = wait.until(EC.element_to_be_clickable((By.CLASS_NAME, "popup-body__btn")))
        btn_capnhat.click()
        time.sleep(1)

        # Há»§y xÃ¡c thá»±c sá»‘ Ä‘iá»‡n thoáº¡i (náº¿u Ä‘Æ°á»£c chá»n)
        if user_data[user_id]['unverify']:
            await update_status(update, "ğŸ“± Äang há»§y xÃ¡c thá»±c sá»‘ Ä‘iá»‡n thoáº¡i...")
            driver.get("https://vtcgame.vn/thong-tin-tai-khoan")
            time.sleep(1)

            driver.execute_script("Account.UnVerifyPhoneNew();")
            time.sleep(1)

            otp_input = wait.until(EC.presence_of_element_located((By.ID, "txtOTPPhone")))
            
            otp_input.clear()
            time.sleep(1)
            otp_input.send_keys(otp)
            time.sleep(1)

            unverify_confirm_button = wait.until(EC.element_to_be_clickable((By.CLASS_NAME, "popup-body__btn")))
            unverify_confirm_button.click()
            time.sleep(1)

        if user_data[user_id]['unverify']:
            await update_status(update, "âœ… ÄÃ£ Ä‘á»•i máº­t kháº©u vÃ  há»§y xÃ¡c thá»±c sá»‘ Ä‘iá»‡n thoáº¡i thÃ nh cÃ´ng!")
        else:
            await update_status(update, "âœ… ÄÃ£ Ä‘á»•i máº­t kháº©u thÃ nh cÃ´ng! Sá»‘ Ä‘iá»‡n thoáº¡i váº«n Ä‘Æ°á»£c giá»¯ nguyÃªn.")
    except Exception as e:
        await update_status(update, f"âŒ CÃ³ lá»—i xáº£y ra: {e}")
    finally:
        cleanup_driver(user_id)
        return ConversationHandler.END

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Gá»­i hÆ°á»›ng dáº«n sá»­ dá»¥ng bot."""
    help_text = (
        "ğŸ›  **HÆ°á»›ng dáº«n sá»­ dá»¥ng bot Ä‘á»•i máº­t kháº©u VTC** ğŸ› \n\n"
        "âš¡ **Lá»‡nh chÃ­nh:**\n"
        " - /start: Báº¯t Ä‘áº§u má»™t phiÃªn má»›i.\n"
        " - /cancel: Há»§y phiÃªn Ä‘ang cháº¡y vÃ  dá»n dáº¹p tÃ i nguyÃªn.\n"
        " - /help: Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n sá»­ dá»¥ng.\n\n"
        "âš¡ **Quy trÃ¬nh Ä‘á»•i máº­t kháº©u:**\n"
        "1ï¸âƒ£ Nháº­p thÃ´ng tin theo Ä‘á»‹nh dáº¡ng:\n"
        "`tÃ i khoáº£n|máº­t kháº©u cÅ©|máº­t kháº©u má»›i|sá»‘ Ä‘iá»‡n thoáº¡i|Y/N`\n"
        "(Y: há»§y xÃ¡c thá»±c sá»‘ Ä‘iá»‡n thoáº¡i, N: khÃ´ng há»§y xÃ¡c thá»±c)\n\n"
        "2ï¸âƒ£ Nháº­p mÃ£ OTP khi Ä‘Æ°á»£c yÃªu cáº§u.\n"
        "3ï¸âƒ£ HoÃ n táº¥t viá»‡c Ä‘á»•i máº­t kháº©u.\n\n"
        "Náº¿u gáº·p lá»—i, vui lÃ²ng kiá»ƒm tra thÃ´ng tin Ä‘áº§u vÃ o hoáº·c thá»­ láº¡i sau."
    )
    await update.message.reply_text(help_text, parse_mode='Markdown')
   



def main():
    # Kill táº¥t cáº£ Firefox process khi khá»Ÿi Ä‘á»™ng bot
    kill_firefox_processes()

    application = Application.builder().token('YOUR_BOT_TOKEN_HERE').build()
    
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            WAITING_INFO: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_info)],
            WAITING_OTP: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_otp)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )

    application.add_handler(conv_handler)
    print("Bot Ä‘Ã£ sáºµn sÃ ng vÃ  Ä‘ang cháº¡y...", flush=True)
    
    
    application.add_handler(CommandHandler('help', help_command))
    application.run_polling(allowed_updates=Update.ALL_TYPES)
    



if __name__ == '__main__':
    main()
